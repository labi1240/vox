!function(e){"function"==typeof define&&define.amd?define("timeline",e):e()}(function(){"use strict";var s={template:"#create-post-media-popup",props:{multiple:{type:Boolean,default:!0},ignore:{type:Array,default:[]},customTarget:[Object,String],saveLabel:String},emits:["save","blur","open"],data(){return{files:[],selected:{},active:!1,loading:!0,has_more:!1,firstLoad:!0,search:{term:"",offset:0,loading:!1,loading_more:!1,has_more:!1,list:null}}},methods:{getStyle(e){return e.type.startsWith("image/")?`background-image: url('${e.preview}');`:""},selectFile(e){this.selected[e.id]?delete this.selected[e.id]:(this.multiple||(this.selected={}),this.selected[e.id]=e)},loadMedia(){jQuery.get(Voxel_Config.ajax_url+"&action=list_media",{offset:this.files.length}).always(e=>{this.loading=!1,e.success?(this.files.push(...e.data),this.has_more=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},loadMore(){this.loading=!0,this.loadMedia()},openLibrary(){this.$emit("open"),this.firstLoad&&this.loadMedia(),this.firstLoad=!1,this.active=!this.active},isImage(e){return e.type.startsWith("image/")},save(){this.active=!1,this.$emit("save",this.selected),this.selected={}},clear(){this.selected={}},clientSearchFiles(){let t=this.search.term.trim().toLowerCase(),s=[],i=!1;this.files.forEach(e=>{i||-1!==e.name.toLowerCase().indexOf(t)&&(s.push(e),i=10<=s.length)}),this.search.list=s,this.search.loading=!1,this.search.has_more=!1,this.search.loading_more=!1},serverSearchFiles:Voxel.helpers.debounce((t,s=!1)=>{jQuery.get(Voxel_Config.ajax_url+"&action=list_media",{offset:s?t.search.list.length:0,search:t.search.term.trim()}).always(e=>{t.search.loading=!1,t.search.loading_more=!1,e.success?(s?t.search.list.push(...e.data):t.search.list=e.data,t.search.has_more=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})})},watch:{"search.term"(){this.search.term.trim()&&this.files&&(this.search.loading=!0,!this.has_more||this.search.term.trim().length<=2?this.clientSearchFiles():this.serverSearchFiles(this))}}},i={template:"#create-post-file-field",props:{field:Object,mediaTarget:[Object,String],index:{type:Number,default:null},sortable:{type:Boolean,default:!0},showLibrary:{type:Boolean,default:!0},previewImages:{type:Boolean,default:!0}},data(){return{accepts:"",dragActive:!1}},created(){null===this.field.value&&(this.field.value=[]),this.accepts=Object.values(this.field.props.allowedTypes).join(", "),this.$watch(()=>this.field.value,()=>{this.validate(this.field.value)},{deep:!0})},mounted(){this.updatePreviews(),jQuery(this.$refs.input).on("change",e=>{for(var t=0;t<e.target.files.length;t++){var s=e.target.files[t];this.pushFile(s)}this.$refs.input.value="",this.updatePreviews(),this.$emit("files-added")}),jQuery(()=>{var e=jQuery(this.$refs.fileList);this.sortable&&this.field.props.sortable&&(e.sortable({items:"> .ts-file",helper:"clone",appendTo:this.$el,containment:"parent",tolerance:"intersect",revert:150}),e.on("sortupdate",()=>{var s=[];e.find(".ts-file").each((e,t)=>{s.push(this.field.value[t.dataset.index])}),this.field.value=s,this.updatePreviews()})),e.find(".pick-file-input").on("click",e=>{e.preventDefault(),this.$refs.input.click()})})},unmounted(){setTimeout(()=>{Object.values(this.field.value).forEach(e=>{"new_upload"===e.source&&URL.revokeObjectURL(e.preview)})},10),this.sortable&&this.field.props.sortable&&jQuery(this.$refs.fileList).sortable("destroy")},methods:{getStyle(e){return e.type.startsWith("image/")&&this.previewImages?`background-image: url('${e.preview}');`:""},updatePreviews(){var e=jQuery(this.$refs.fileList),i=[];this.field.value.forEach((e,t)=>{var s=e.type.startsWith("image/")&&this.previewImages,s=jQuery(`
					<div class="ts-file ${s?"ts-file-img":""}" style="${this.getStyle(e)}" data-index="${t}">
						<div class="ts-file-info">
							<svg fill="#000000" width="52" height="52" version="1.1" id="lni_lni-cloud-upload" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 64 64" style="enable-background:new 0 0 64 64;" xml:space="preserve">
								<g>
									<path d="M34.3,27.3c-0.5-0.5-1.1-0.8-1.8-0.8c-0.7,0-1.3,0.3-1.8,0.8l-4.9,5.1c-0.7,0.7-0.7,1.8,0,2.5c0.7,0.7,1.8,0.7,2.5,0
										l2.5-2.6v9.5c0,1,0.8,1.8,1.8,1.8c1,0,1.8-0.8,1.8-1.8v-9.5l2.5,2.6c0.3,0.4,0.8,0.5,1.3,0.5c0.4,0,0.9-0.2,1.2-0.5
										c0.7-0.7,0.7-1.8,0-2.5L34.3,27.3z"/>
									<path d="M57.8,23.7c-2.7-2.9-6.6-4.9-10.6-5.6c-2.2-3.5-5.5-6.1-9.3-7.4c-1.7-0.6-3.7-1-5.8-1c-9.6,0-17.5,7.5-17.9,16.9
										C6.9,27.2,1.3,33.2,1.3,40.4c0,7.6,6.3,13.8,14.1,13.9c0,0,0,0,0,0h28.8c10.3,0,18.6-8.2,18.6-18.2C62.8,31.5,61,27.1,57.8,23.7z
										 M44.1,50.8H15.4c-6,0-10.6-4.6-10.6-10.4S9.4,30,15.4,30h0.5c1,0,1.8-0.8,1.8-1.8v-1.1c0-7.7,6.5-14,14.4-14
										c1.7,0,3.2,0.3,4.6,0.8c3.3,1.1,6.1,3.5,7.9,6.6c0.3,0.5,0.8,0.8,1.3,0.9c3.6,0.4,7,2,9.3,4.6c2.6,2.8,4,6.3,4,10
										C59.3,44.2,52.5,50.8,44.1,50.8z"/>
								</g>
						</svg><code></code>
						</div>
						<a href="#" class="ts-remove-file flexify"><svg fill="#000000" width="52" height="52" version="1.1" id="lni_lni-close" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
							 y="0px" viewBox="0 0 64 64" style="enable-background:new 0 0 64 64;" xml:space="preserve">
						<path d="M34.5,32L62.2,4.2c0.7-0.7,0.7-1.8,0-2.5c-0.7-0.7-1.8-0.7-2.5,0L32,29.5L4.2,1.8c-0.7-0.7-1.8-0.7-2.5,0
							c-0.7,0.7-0.7,1.8,0,2.5L29.5,32L1.8,59.8c-0.7,0.7-0.7,1.8,0,2.5c0.3,0.3,0.8,0.5,1.2,0.5s0.9-0.2,1.2-0.5L32,34.5l27.7,27.8
							c0.3,0.3,0.8,0.5,1.2,0.5c0.4,0,0.9-0.2,1.2-0.5c0.7-0.7,0.7-1.8,0-2.5L34.5,32z"/>
						</svg></a>
					</div>
				`);s.find("code").text(e.name),s.find("a").on("click",e=>{e.preventDefault(),this.field.value.splice(t,1),this.updatePreviews()}),i.push(s)}),e.find(".pick-file-input").siblings().remove(),e.append(i)},pushFile(e){1===this.field.props.maxCount&&(this.field.value=[]),this.field.value.push({source:"new_upload",name:e.name,type:e.type,size:e.size,preview:URL.createObjectURL(e),item:e})},onDrop(e){this.dragActive=!1,e.dataTransfer.items?[...e.dataTransfer.items].forEach(e=>{"file"===e.kind&&this.pushFile(e.getAsFile())}):[...e.dataTransfer.files].forEach(e=>{this.pushFile(e)}),this.updatePreviews(),this.$emit("files-added")},onMediaPopupSave(e){1===this.field.props.maxCount&&(this.field.value=[]);var t={};this.field.value.forEach(e=>{"existing"===e.source&&(t[e.id]=!0)}),Object.values(e).forEach(e=>{t[e.id]||this.field.value.push(e)}),this.updatePreviews(),this.$emit("files-added")},onSubmit(t,s,e=null){var i;i=null!==e?`files[${this.field.id}::row-${e}][]`:`files[${this.field.id}][]`,t[this.field.key]=[],this.field.value.forEach(e=>{"new_upload"===e.source?(s.append(i,e.item),t[this.field.key].push("uploaded_file")):"existing"===e.source&&t[this.field.key].push(e.id)})},async cacheToLocalStorage(r){r[this.field.key]=[];let e=[];return this.field.value.forEach(i=>{if("existing"===i.source)r[this.field.key].push(i);else if("new_upload"===i.source){let t={source:"local_storage",name:i.item.name,type:i.item.type,lastModified:i.item.lastModified,dataUrl:null},s=new FileReader;e.push(new Promise(e=>{s.onload=()=>{t.dataUrl=s.result,r[this.field.key].push(t),e()},s.readAsDataURL(i.item)}))}}),Promise.all(e)},async applyFromLocalStorage(t){if(Array.isArray(t)&&t.length){let e=[];return t.forEach(s=>{e.push(new Promise(t=>{fetch(s.dataUrl).then(e=>e.blob()).then(e=>{this.pushFile(new File([e],s.name,{type:s.type,lastModified:new Date})),t()})}))}),Promise.all(e).then(()=>this.$root.$nextTick(this.updatePreviews())),Promise.all(e)}},validate(e){if(this.$root.shouldValidate()){let t=[];var r=!(Array.isArray(e)&&1<=e.length),a=this.field.props.maxCount;let s=this.field.props.maxSize,i=this.field.props.allowedTypes;this.$root.shouldValidateRequired()&&this.field.required&&r&&t.push(this.$root.get_error("required")),r||(a&&e.length>a&&t.push(this.$root.replace_vars(this.$root.get_error("file:max"),{"@max":a})),s&&e.forEach(e=>{"new_upload"===e.source&&e.size>1e3*s&&t.push(this.$root.replace_vars(this.$root.get_error("file:size"),{"@filename":e.name,"@limit_kb":s,"@limit_mb":s/1e3}))}),Array.isArray(i)&&i.length&&e.forEach(e=>{i.includes(e.type)||t.push(this.$root.replace_vars(this.$root.get_error("file:type"),{"@filename":e.name,"@filetype":e.type}))})),this.field.validation.errors=t}}}},r={template:"#timeline-create-status",props:{status:Object,index:Number,customPopupKey:String,showTrigger:{type:Boolean,default:!0}},data(){return{pending:!1,message:"",files:{label:this.$root.config.l10n.attachImages,key:"files",id:"files",value:[],props:{allowedTypes:[],maxCount:3}},ratings:{},showFiles:!1}},created(){this.status&&this.setupData(this.status)},methods:{setupData(s){this.message=s.raw_content,this.files.value=s.files?.slice()||[],this.files.value.length&&(this.showFiles=!0),this.$root.config.reviews[s.post.post_type]?.categories.forEach(e=>{let t=s.reviews?.ratings?.[e.key];[-2,-1,0,1,2].includes(t)&&(this.ratings[e.key]=this.$root.config.reviews[s.post.post_type]?.rating_levels.find(e=>e.score===t))})},publish(){this.pending=!0,this.status&&(this.status._pending=!0);var e=new FormData;let s={};Object.keys(this.ratings).forEach(e=>{var t=this.ratings[e];t&&(s[e]=t.score)});var t={message:this.message,ratings:s},t=(this.$refs.files?.onSubmit(t,e),e.append("fields",JSON.stringify(t)),jQuery.param({action:this.status?"timeline.status.edit":"timeline.status.publish",post_id:this.$root.config.postId,status_id:this.status?.id,mode:this.$root.mode}));jQuery.post({url:Voxel_Config.ajax_url+"&"+t,data:e,contentType:!1,processData:!1}).always(e=>{this.pending=!1,this.status&&(this.status._pending=!1),e.success?(this.status?this.$root.statuses.list.splice(this.index,1,e.status):(this.$root.statuses.list.unshift(e.status),this.message="",this.ratings={},this.$refs.files&&(this.$refs.files.field.value=[],this.$refs.files.updatePreviews())),this.$refs.popup.blur(),this.$root.setExistingReview()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},cancel(){this.$refs.popup.blur()},isRatingSelected(e,t){return this.ratings[t.key]&&this.ratings[t.key].score===e.score},isRatingActive(e,t){return this.ratings[t.key]&&this.ratings[t.key].score>=e.score},resizeComposer(){this.$refs.composer&&(this.$refs.composer.style.height="5px",this.$refs.composer.style.height=this.$refs.composer.scrollHeight+"px")}},computed:{popupKey(){return this.customPopupKey||"create-status-"+(this.status?this.status.id:"-new")}},watch:{"$root.activePopup"(e){this.popupKey===e&&this.$nextTick(()=>requestAnimationFrame(()=>this.resizeComposer()))}}},a={template:"#timeline-create-reply",props:{status:Object,parent:Object,grandParent:Object,reply:Object,index:Number,showTrigger:{type:Boolean,default:!0}},data(){return{pending:!1,message:""}},created(){this.reply&&this.setupData(this.reply)},methods:{setupData(e){this.message=e.raw_content},publish(){this.pending=!0,this.reply&&(this.reply._pending=!0);var e=new FormData,t={message:this.message},t=(e.append("fields",JSON.stringify(t)),jQuery.param({action:this.reply?"timeline.reply.edit":"timeline.reply.publish",post_id:this.$root.post_id,status_id:this.status.id,parent_id:this.parent?.id,reply_id:this.reply?.id}));jQuery.post({url:Voxel_Config.ajax_url+"&"+t,data:e,contentType:!1,processData:!1}).always(e=>{var t;this.pending=!1,e.success?(this.reply?(this.reply._pending=!1,(this.parent?this.parent.replies:this.status.highlightedReplies&&!this.status.replies.requested?this.status.highlightedReplies:this.status.replies).list.splice(this.index,1,e.reply)):(this.parent?(t=e.reply.reply_to.exists?this.grandParent:this.parent)?(t.reply_count=e.parent_reply_count,t.replies.requested&&t.replies.list.push(e.reply),t.replies.visible=!0):(this.status.highlightedReplies&&!this.status.replies.requested?this.status.highlightedReplies:this.status.replies).list.push(e.reply):this.status.replies.list.push(e.reply),this.status.reply_count=e.status_reply_count,this.message=""),this.$refs.popup.blur()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},cancel(){this.$refs.popup.blur()},resizeComposer(){this.$refs.composer&&(this.$refs.composer.style.height="5px",this.$refs.composer.style.height=this.$refs.composer.scrollHeight+"px")}},computed:{popupKey(){var e=this.reply?this.reply.key:"new";return`reply:${this.status.id}-${this.parent?.id||0}-`+e}},watch:{"$root.activePopup"(e){this.popupKey===e&&this.$nextTick(()=>requestAnimationFrame(()=>this.resizeComposer()))}}},l={template:"#timeline-status-replies",props:{status:Object,parent:Object,replies:Object},created(){this.replies.requested||(this.replies.requested=!0,(!this.parent||null!==this.parent.reply_count)&&(this.parent||null!==this.status.reply_count)?this.getReplies():(this.replies.loading=!1,this.replies.hasMore=!1))},methods:{getReplies(){this.replies.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline.status.get_replies",{page:this.replies.page,status_id:this.status.id,parent_id:this.parent?.id}).always(e=>{e.success?(this.replies.list.push(...e.data),this.replies.hasMore=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.replies.loading=!1})},likeReply(t,e){if(!Voxel_Config.is_logged_in)return Voxel.authRequired();let s=this.$refs[t.key+":likeBtn"];s.classList.toggle("ts-liked"),s.classList.add("vx-pending"),jQuery.get(Voxel_Config.ajax_url+"&action=timeline.reply.like",{reply_id:t.id}).always(e=>{s.classList.remove("vx-pending"),e.success?(t.liked_by_user=e.liked_by_user,t.like_count=e.like_count):(s.classList.toggle("ts-liked"),Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"))})},deleteReply(t,s){confirm("Are you sure?")&&(t._pending=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline.reply.delete",{reply_id:t.id}).always(e=>{t._pending=!1,e.success?(this.replies.list.splice(s,1),this.parent&&(this.parent.reply_count=e.parent_reply_count),this.status.reply_count=e.status_reply_count):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")}))},showReplyBox(e,t){if(!Voxel_Config.is_logged_in)return Voxel.authRequired();this.$root.activePopup="reply:"+t.id+"-"+e.id+"-new"}}},o={template:"#timeline-single-status",props:{status:Object,index:Number},data(){return{contentLength:256}},methods:{likeStatus(){if(!Voxel_Config.is_logged_in)return Voxel.authRequired();let t=this.$refs.likeBtn;t.classList.toggle("ts-liked"),t.classList.add("vx-pending"),jQuery.get(Voxel_Config.ajax_url+"&action=timeline.status.like",{status_id:this.status.id}).always(e=>{t.classList.remove("vx-pending"),e.success?(this.status.liked_by_user=e.liked_by_user,this.status.like_count=e.like_count):(t.classList.toggle("ts-liked"),Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"))})},deleteStatus(){confirm(Voxel_Config.l10n.confirmAction)&&(this.status._pending=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline.status.delete",{status_id:this.status.id}).always(e=>{this.status._pending=!1,e.success?this.$root.statuses.list.splice(this.index,1):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.$root.setExistingReview()}))},truncate(e){var t=document.createElement("div");t.innerHTML=e;let s=this.contentLength,i=!1,r=0,a=e=>{var t;i?e.remove():(t=Array.from(e.childNodes)).length?t.forEach(e=>a(e)):(r+=e.textContent.length)>=s&&(i=!0,r>s&&(e.textContent=e.textContent.slice(0,-(r-s))),e.textContent+="…")};return a(t),{content:t.innerHTML,exists:i}}},computed:{truncated(){return this.truncate(this.status.content)}}};window.render_timeline=()=>{Array.from(document.querySelectorAll(".ts-social-feed")).forEach(e=>{var t;e.__vue_app__||((t=Vue.createApp({el:e,mixins:[Voxel.mixins.base],data(){return{widget:"timeline",config:null,activePopup:null,statusId:null,replyId:null,orderingOptions:[],activeOrder:null,mode:null,existingReview:null,statuses:{page:1,loading:!0,hasMore:!1,list:[]}}},created(){var e=JSON.parse(this.$options.el.dataset.config);this.config=e,this.statusId=e.statusId,this.replyId=e.replyId,this.mode=e.mode,this.orderingOptions=e.orderingOptions,1<=this.orderingOptions.length&&(this.activeOrder=this.orderingOptions[0]),this.statusId?this.getSingleStatus():this.getStatuses()},methods:{getStatuses(){this.statuses.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline.get",{page:this.statuses.page,order_type:this.activeOrder?.order,order_time:this.activeOrder?.time,order_time_custom:this.activeOrder?.time_custom,mode:this.mode,post_id:this.config.postId,author_id:this.config.authorId,_review_post_types:JSON.stringify(Object.keys(this.config.reviews))}).always(e=>{e.success?(e.data.forEach(e=>{e.review_config&&(this.config.reviews[e.review_config.post_type]=e.review_config)}),this.statuses.list.push(...e.data),this.statuses.hasMore=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),1===this.statuses.page&&this.setExistingReview(),this.statuses.loading=!1})},getSingleStatus(){this.statuses.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=timeline.get_status",{status_id:this.statusId,reply_id:this.replyId}).always(e=>{e.success?this.statuses.list.push(e.status):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.statuses.loading=!1})},setActiveOrder(e){this.activeOrder=e,this.statuses.page=1,this.statuses.loading=!0,this.statuses.hasMore=!1,this.statuses.list=[],this.getStatuses()},getLevelForScore(t,e){return this.config.reviews[e]?.rating_levels.find(e=>t>=e.score-.5&&t<e.score+.5)},getReviewConfig(e){return e?this.config.reviews[e.post?.post_type]:this.config.reviews[this.config.postType]},joinDiscussion(){var e=new URL(window.location),t=(e.hash="tl:"+this.widget_id,new URL(Voxel_Config.login_url));t.searchParams.set("redirect_to",e.toString()),window.location.href=t.toString()},setExistingReview(){if(this.existingReview=null,"post_reviews"===this.mode&&Voxel_Config.is_logged_in){let e=this.statuses.list.findIndex(e=>e.user.id===Voxel_Config.current_user_id);-1!==e&&this.$nextTick(()=>{this.existingReview={status:this.statuses.list[e],index:e}})}},shouldValidate(e){return!1}},computed:{isSingle(){return null!==this.statusId}}})).component("form-popup",Voxel.components.popup),t.component("form-group",Voxel.components.formGroup),t.component("create-status",r),t.component("create-reply",a),t.component("status-replies",l),t.component("single-status",o),i.template="#timeline-file-field",t.component("media-popup",s),t.component("field-file",i),t.mount(e))})},window.render_timeline(),jQuery(document).on("voxel:markup-update",window.render_timeline)});
