!function(e){"function"==typeof define&&define.amd?define("postTypeEditor",e):e()}(function(){"use strict";var i={template:"#post-type-settings-template",data(){return{activeExpirationRule:null,activeReviewTab:null}},created(){this.$root.config.settings.expiration.rules=this.$root.config.settings.expiration.rules.filter(e=>this.isExpirationRuleValid(e))},methods:{exportRevision(e){return`${Voxel_Config.ajax_url}&action=pte.export_revision&post_type=${this.$root.config.settings.key}&timestamp=`+e},rollbackRevision(e){return`${Voxel_Config.ajax_url}&action=pte.rollback_revision&post_type=${this.$root.config.settings.key}&timestamp=`+e},removeRevision(t){confirm("Are you sure?")&&(this.$root.options.revisions=this.$root.options.revisions.filter(e=>e!==t),jQuery.get(`${Voxel_Config.ajax_url}&action=pte.remove_revision&post_type=${this.$root.config.settings.key}&timestamp=`+t.timestamp))},importConfig(e){var t=new FileReader;t.onload=e=>{try{var t=JSON.parse(e.target.result);jQuery.post(Voxel_Config.ajax_url,{action:"pte.import_config",post_type:this.$root.config.settings.key,config:JSON.stringify(t)}).always(e=>{e.success?location.replace(e.redirect_to):Voxel_Backend.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}catch(e){return alert("Error: "+e.message)}},t.readAsText(e.target.files[0],"UTF-8")},isExpirationRuleValid(e){return"fixed"===e.type||"field"===e.type&&this.$root.getFieldByKey(e.field)},getExpirationRuleLabel(e){return"fixed"===e.type?"Expire posts after a fixed number of days":!(e=this.$root.getFieldByKey(e.field))||"recurring-date"!==e.type&&"date"!==e.type?void 0:`Expire posts when the end date for ${e.label} field is reached`},addExpirationRule(e){this.$root.config.settings.expiration.rules.push(e)},deleteExpirationRule(t){this.$root.config.settings.expiration.rules=this.$root.config.settings.expiration.rules.filter(e=>e!==t)},deleteReviewCategory(t){this.$root.config.settings.reviews.categories=this.$root.config.settings.reviews.categories.filter(e=>e.key!==t)},createReviewCategory(){var e=Math.floor(900*Math.random())+100;this.$root.config.settings.reviews.categories.push({label:"Custom category",key:"custom-"+e,required:!1})}},computed:{expirationRules(){let e=[],i=this.$root.config.settings.expiration.rules;return i.find(e=>"fixed"===e.type)||e.push({type:"fixed",amount:30}),this.$root.config.fields.forEach(t=>{"recurring-date"!==t.type&&"date"!==t.type||i.find(e=>"field"===e.type&&e.field===t.key)||e.push({type:"field",field:t.key})}),e}}},s={template:"#post-type-templates-template",methods:{editWithElementor(e){return this.$root.options.elementor_edit_link.replace("{id}",e)},elementorPreviewLink(e){return this.$root.options.elementor_preview_link.replace("{id}",e)},createCustomTemplate(e){this.$root.activePopup="create-custom:"+e},createPage(t){jQuery.get(Voxel_Config.ajax_url,{action:"pte.create_page",post_type:this.$root.config.settings.key,group:t}).always(e=>{e.success?this.$root.config.templates[t]=e.template_id:Voxel_Backend.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},deleteTemplate(e,t,i){confirm("Are you sure you want to delete this template?")&&jQuery.get(Voxel_Config.ajax_url,{action:"pte.delete_template",post_type:this.$root.config.settings.key,id:t,group:i}).always(e=>{e.success?e.custom_templates?this.$root.config.custom_templates=e.custom_templates:this.$root.config.templates=e.templates:Voxel_Backend.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},dragStart(){},dragEnd(t){t.target.classList.add("vx-inert"),jQuery.post(Voxel_Config.ajax_url+"&action=pte.update_template_order",{post_type:this.$root.config.settings.key,custom_templates:JSON.stringify(this.$root.config.custom_templates)}).always(e=>{t.target.classList.remove("vx-inert"),e.success||Voxel_Backend.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}}},o={template:"#post-type-search-forms-template"},r={template:"#post-type-search-filters-template",data(){return{filter_types:this.$root.options.filter_types,active:null}},methods:{isActive(e){return this.active===e},toggleActive(e){return this.active=e===this.active?null:e},addFilter(e){var t=$.extend(!0,{},e);if(!e.singular){for(var i=1,s=t.type,o=s;this.$root.getFilterByKey(o);)o=s+"-"+ ++i,27===i&&(o=s+"-twentyseven");t.key=o}this.$root.config.search.filters.push(t)},canAddFilter(t){return!t.singular||!this.$root.config.search.filters.find(e=>e.type===t.type)},deleteFilter(t){this.$root.config.search.filters=this.$root.config.search.filters.filter(e=>e!==t)},dragStart(){this.$refs["fields-container"].classList.add("drag-active")},dragEnd(){this.$refs["fields-container"].classList.remove("drag-active")}}},a={template:"#post-type-search-order-template",data(){return{active:null,activeClause:null}},methods:{isActive(e){return this.active===e},toggleActive(e){this.active=e===this.active?null:e,this.active&&this.active.clauses.length&&(this.activeClause=this.active.clauses[0])},addPresetOption(e){this.$root.config.search.order.push(jQuery.extend(!0,{},e))},addOrderingOption(){var e={key:"order-"+(Math.floor(9e3*Math.random())+1e3),label:"Custom order",clauses:[]};this.$root.config.search.order.push(e),this.active=e},deleteOrderingOption(t){this.$root.config.search.order=this.$root.config.search.order.filter(e=>e!==t)},dragStart(){this.$refs["fields-container"].classList.add("drag-active")},dragEnd(){this.$refs["fields-container"].classList.remove("drag-active")},addClause(e,t){e=$.extend(!0,{},e);t.clauses.push(e),this.activeClause=e},deleteClause(t,e){e.clauses=e.clauses.filter(e=>e!==t)},getClauseLabel(e){return this.$root.options.orderby_type_labels[e.type]}}},n={template:"#post-type-fields-template",data(){return{field_types:this.$root.options.field_types,field_presets:this.$root.options.field_presets,active:null,active_set:"presets",search:""}},methods:{isActive(e){return this.active===e},setActive(e){this.active=e},toggleActive(e){return this.active=e===this.active?null:e},addField(e){var t=$.extend(!0,{},e);if(!e.singular){for(var i=1,s=t.type,o=s;this.$root.getFieldByKey(o);)o=s+"-"+ ++i,27===i&&(o=s+"-twentyseven");t.key=o}this.$root.config.fields.push(t)},deleteField(t){this.$root.config.fields=this.$root.config.fields.filter(e=>e!==t)},canAddPreset(t){return!this.$root.config.fields.find(e=>e.key===t.key)},dragStart(){this.$refs["fields-container"].classList.add("drag-active")},dragEnd(){this.$refs["fields-container"].classList.remove("drag-active")}},computed:{search_results(){var e,t,i={presets:[],field_types:[]},s=this.search.trim().toLowerCase();for(e of Object.values(this.field_presets))("string"==typeof e.key&&-1!==e.key.toLowerCase().indexOf(s)||"string"==typeof e.label&&-1!==e.label.toLowerCase().indexOf(s)||"string"==typeof e.type&&-1!==e.type.toLowerCase().indexOf(s))&&i.presets.push(e);for(t of Object.values(this.field_types))("string"==typeof t.key&&-1!==t.key.toLowerCase().indexOf(s)||"string"==typeof t.label&&-1!==t.label.toLowerCase().indexOf(s)||"string"==typeof t.type&&-1!==t.type.toLowerCase().indexOf(s))&&i.field_types.push(t);return i}}},l={template:`
		<div class="ts-icon-picker ts-icon-picker-vue">
			<div class="icon-preview" v-html="previewMarkup" @click.prevent="openLibrary" :title="modelValue"></div>

				<a href="#" @click.prevent="uploadSVG" class="ts-button ts-outline">Upload SVG</a>
				<a v-if="allowFonticons !== false" href="#" @click.prevent="openLibrary" class="ts-button ts-outline">Choose Icon</a>
				<a v-if="modelValue" href="#" @click.prevent="clear" class="ts-button ts-outline icon-only"><i class="lar la-trash-alt icon-sm"></i></a>

		</div>
	`,props:["modelValue","allowFonticons"],data(){return{previewMarkup:""}},created(){this.preview(this.modelValue)},methods:{preview(e){Voxel_Icon_Picker.getIconPreview(e,e=>this.previewMarkup=e)},openLibrary(){Voxel_Icon_Picker.edit(this.modelValue,e=>{this.setValue(e.library+":"+e.value)})},uploadSVG(){Voxel_Icon_Picker.getSVG(e=>{this.setValue("svg:"+e.id)})},clear(){this.setValue("")},setValue(e){this.preview(e),this.$emit("update:modelValue",e)}}},p={template:"#post-type-field-modal-template",props:["field"],data(){return{tab:"general"}},mounted(){this.field.__first_edit&&this.$refs.keyInput?.enable()},methods:{save(){this.$parent.active=null,delete this.field.__first_edit}}},d={template:"#post-type-field-list-item",props:{field:Object,showDelete:Boolean}},c={template:"#post-type-field-props-template",props:{field:Object,repeater:Object},data(){return{tab:"general"}}},u={template:"#post-type-field-conditions-template",props:{field:Object,repeater:Object},data(){return{conditions:[],fields:(this.repeater||this.$root.config).fields}},created(){this.conditions=this.field.conditions,this.$watch(()=>this.field["enable-conditions"],(e,t)=>{!0!==e||this.conditions.length||this.conditions.push([{source:"",type:""}])})},methods:{setProps(t){var i=this.$root.options.condition_types[t.type];i&&(jQuery.extend(t,i.props,{source:t.source}),Object.keys(t).forEach(e=>{"type"!==e&&void 0===i.props[e]&&delete t[e]}))},getConditionGroups(e){e=e.source.split(".");let t=e[0];var e=e[1]||null,i=this.fields.find(e=>e.key===t);return!i||null===(i=this.$root.options.supported_conditions[i.type])?[]:Array.isArray(i)?this._getConditionGroups(i):"object"==typeof i&&null!==e&&Array.isArray(i[e]?.supported_conditions)?this._getConditionGroups(i[e].supported_conditions):[]},_getConditionGroups(e){let i=[];return e.forEach(t=>{var e=Object.values(this.$root.options.condition_types).filter(e=>e.group===t);e.length&&i.push({key:t,label:t.toUpperCase(),types:e})}),i},removeCondition(e,t,i){t.splice(e,1),0===t.length&&1<this.field.conditions.length&&this.field.conditions.splice(i,1)},getSubFields(e){e=this.$root.options.supported_conditions[e.type];return"object"!=typeof e||Array.isArray(e)||null===e?null:e},hasConditions(e){return Array.isArray(this.$root.options.supported_conditions[e.type])}}},h={template:"#post-type-field-visibility-template",props:{field:Object,repeater:Object},methods:{editRules(){DTags.editVisibility(this.field.visibility_rules,e=>{this.field.visibility_rules=e})},displayRules(){return DTags.formatRulesAsHTML(this.field.visibility_rules)}}},g={template:"#post-type-repeater-fields-template",props:{field:Object},data(){return{field_types:this.$root.options.field_types,active:null}},methods:{toggleActive(e){return this.active=e===this.active?null:e},addField(e){var t=$.extend(!0,{},e);if(!e.singular){for(var i=1,s=t.type,o=s;this.field.fields.find(e=>e.key===o);)o=s+"-"+ ++i;t.key=o}this.field.fields.push(t)},deleteField(t){this.field.fields=this.field.fields.filter(e=>e!==t)},dragStart(){this.$refs["fields-container"].classList.add("drag-active")},dragEnd(){this.$refs["fields-container"].classList.remove("drag-active")}}},f={template:`
		<input type="text" readonly :value="modelValue" @click="edit">
	`,props:["modelValue","tagGroups"],data(){return{previewMarkup:""}},methods:{edit(){var t={};Array.isArray(this.tagGroups)?this.tagGroups.forEach(e=>{DTags.groups[e]&&(t[e]=DTags.groups[e])}):t=this.tagGroups||null,DTags.edit(this.modelValue,e=>{this.$emit("update:modelValue",e)},t)}}},m={template:"#post-type-select-field-choices",props:{field:Object},data(){return{active:null}},methods:{add(){var e={value:"",label:"",icon:""};this.field.choices.push(e),this.active=e},remove(t){this.field.choices=this.field.choices.filter(e=>e!==t)},dragStart(){this.$refs["fields-container"].classList.add("drag-active")},dragEnd(){this.$refs["fields-container"].classList.remove("drag-active")}}};jQuery(e=>{var t;document.getElementById("voxel-edit-post-type")&&(window.$=jQuery,(t=Vue.createApp({data(){return{tab:"general",subtab:"base",config:Post_Type_Config,submit_config:"",options:Post_Type_Options,indexing:{loaded:!1,items_total:null,items_indexed:null,running:!1,run_finished:!1,running_offset:null,running_total:null,running_has_more:null},activePopup:null}},created(){window.PTE=this;var e=Voxel_Backend.getSearchParam("tab"),e=(e&&(e=e.split("."),this.setTab(e[0],e[1])),this.options.auto_index&&this.indexPosts(),this.$root.options.revisions.reverse(),Voxel_Backend.getSearchParam("revision"));Voxel_Backend.deleteSearchParam("revision"),"import"===e?Voxel_Backend.alert("Configuration file imported successfully.","info"):"rollback"===e&&Voxel_Backend.alert("Rollback successful.","info")},methods:{setTab(e,t=""){this.tab=e,this.subtab=t;var i=new URL(window.location);i.searchParams.set("tab",t?e+"."+t:e),window.history.replaceState(null,null,i)},prepareSubmission(){this.submit_config=JSON.stringify(this.config)},getFieldByKey(t){return this.config.fields.find(e=>e.key===t)},getFilterByKey(t){return this.config.search.filters.find(e=>e.key===t)},getFieldsByType(t){return"string"==typeof t&&(t=[t]),this.config.fields.filter(e=>t.includes(e.type))},getFiltersByType(t){return"string"==typeof t&&(t=[t]),this.config.search.filters.filter(e=>t.includes(e.type))},getProductAdditionsByType(e,t){"string"==typeof t&&(t=[t]);e=this.$root.options.product_types[e["product-type"]];return e?e.additions.filter(e=>t.includes(e.type)):[]},getIndexData(){this.indexing.loaded||jQuery.get(Voxel_Config.ajax_url,{action:"posts.get_index_data",post_type:this.config.settings.key},e=>{this.indexing.loaded=!0,this.indexing.items_total=e.items_total,this.indexing.items_indexed=e.items_indexed,this.indexing.table_name=e.table_name,this.indexing.table_exists=e.table_exists})},indexPosts(){this.indexing.running=!0,this.indexing.run_finished=!1,jQuery.get(Voxel_Config.ajax_url,{action:"posts.index_all",post_type:this.config.settings.key},e=>{this.indexing.running_total=e.total,this.indexing.running_offset=e.offset,this.indexing.running_has_more=e.has_more,e.has_more?this.indexPosts():this.indexing.run_finished=!0})},forceIndexPosts(){this.indexing.running=!0,this.indexing.run_finished=!1,jQuery.get(Voxel_Config.ajax_url,{action:"posts.recreate_and_index_all",post_type:this.config.settings.key},e=>{this.indexing.running_total=e.total,this.indexing.running_offset=e.offset,this.indexing.running_has_more=e.has_more,e.has_more?this.indexPosts():this.indexing.run_finished=!0})}},computed:{indexingStatus(){var e,t;return this.indexing.running?null===this.indexing.running_offset?"Indexing posts...":this.indexing.running_has_more?(e=this.indexing.running_total,`Indexing ${t=this.indexing.running_offset}/${e} (${(t/e*100).toFixed(1)}%)`):0===(t=this.indexing.running_total)?"No posts to index.":`Indexed ${t}/${t} (100%)`:""},$w(){return window}}})).component("general-settings",i),t.component("page-templates",s),t.component("search-forms",o),t.component("search-filters",r),t.component("search-order",a),t.component("field-key",Voxel_Backend.components.Field_Key),t.component("taxonomy-select",Voxel_Backend.components.Taxonomy_Select),t.component("media-select",Voxel_Backend.components.Media_Select),t.component("color-picker",Voxel_Backend.components.Color_Picker),t.component("icon-picker",l),t.component("form-fields",n),t.component("field-conditions",u),t.component("field-visibility",h),t.component("field-modal",p),t.component("field-list-item",d),t.component("draggable",vuedraggable),t.component("repeater-fields",g),t.component("field-props",c),t.component("dtag-input",f),t.component("select-field-choices",m),t.component("template-visibility-rules",{template:'<span class="hide"></span>',props:{template:Object},data(){return{priority:this.priority,updating:!1}},mounted(){this.editRules()},methods:{saveRules(){this.updating=!0,jQuery.get(Voxel_Config.ajax_url,{action:"pte.update_template",post_type:this.$root.config.settings.key,template_id:this.template.id,label:this.template.label,group:this.template.group,priority:this.template.priority,visibility_rules:this.template.visibility_rules}).always(e=>{this.updating=!1,e.success?(this.$root.config.custom_templates=e.templates,this.template.editRules=!1):Voxel_Backend.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},editRules(){DTags.editVisibility(this.template.visibility_rules,e=>{this.template.visibility_rules=e,this.saveRules()},()=>this.template.editRules=!1)}}}),t.component("create-custom-template",{template:"#ts-create-custom-template",props:["group"],data(){return{label:"",updating:!1}},methods:{saveId(){this.updating=!0,jQuery.get(Voxel_Config.ajax_url,{action:"pte.create_template",post_type:this.$root.config.settings.key,label:this.label,group:this.group}).always(e=>{this.updating=!1,e.success?(this.$root.config.custom_templates=e.templates,this.$root.activePopup=null):Voxel_Backend.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}}}),t.component("base-template-options",{template:"#ts-base-template-options",props:["template"],data(){return{modifyId:!1,newId:this.$root.config.templates[this.template],updating:!1}},methods:{saveId(){this.updating=!0,jQuery.get(Voxel_Config.ajax_url,{action:"backend.update_page_id",template_key:"template."+this.template,post_type:this.$root.config.settings.key,template_type:"form"===this.template?"page":"template",new_template_id:this.newId}).always(e=>{this.updating=!1,e.success?(this.$root.config.templates=e.templates,this.modifyId=!1):Voxel_Backend.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}}}),t.component("custom-template-options",{template:"#ts-custom-template-options",props:{template:Object},data(){return{label:this.template.label,newId:this.template.id,updating:!1}},methods:{saveId(){this.updating=!0,jQuery.get(Voxel_Config.ajax_url,{action:"pte.update_template",post_type:this.$root.config.settings.key,template_id:this.template.id,label:this.template.label,group:this.template.group}).always(e=>{this.updating=!1,e.success?(this.$root.config.custom_templates=e.templates,this.template.editSettings=!1):Voxel_Backend.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}}}),t.mount("#voxel-edit-post-type"))})});
