!function(e){"function"==typeof define&&define.amd?define("backend",e):e()}(function(){"use strict";jQuery(i=>{var e,t;document.getElementById("voxel-icon-picker")&&((e=Vue.createApp({template:"#voxel-icon-picker-template",data(){return{activePack:null,config:window.Voxel_Icon_Picker_Config,search:"",searchResults:{},inited:!1,opened:!1,fileFrame:null}},created(){window.Voxel_Icon_Picker=this},methods:{selectIcon(e,t){var a=this.config[t],a={value:a.displayPrefix+" "+a.prefix+e,library:t};this.emitter.emit("save",a)},init(){Object.values(this.config).forEach(e=>{this.loadPack(e)}),this.setPack(Object.keys(this.config)[0])},loadStylesheet(e){i(`link[href="${e}"]`).length||i("head").append(i("<link>",{rel:"stylesheet",type:"text/css",href:e}))},setPack(e){this.activePack=this.config[e],this.activePack.loaded||this.loadPack(this.activePack)},loadPack(t){t.loaded||(t.enqueue&&t.enqueue.forEach(e=>this.loadStylesheet(e)),t.url&&this.loadStylesheet(t.url),i.getJSON(t.fetchJson,e=>{t.list=e?.icons||[],t.loaded=!0}))},open(){this.inited||(this.init(),this.inited=!0),this.opened=!0},close(){this.opened=!1},edit(e,t){this.open();var a=e=>{t(e),this.emitter.off("save",a),this.close()};this.emitter.on("save",a)},filter(){this.searchResults={},Object.values(this.config).forEach(e=>{var t=[];this.loadPack(e),e.list.forEach(e=>{-1!==e.indexOf(this.search)&&t.push(e)}),t.length&&(this.searchResults[e.name]=t)})},getSVG(t){this.fileFrame||(this.fileFrame=wp.media({states:new wp.media.controller.Library({multiple:!1,library:wp.media.query({type:["image/svg+xml"]})})}));var e=Vue.toRaw(this.fileFrame);e.open(),e.once("select",()=>{e.state().get("selection").each(e=>t(e.toJSON()))})},getIconPreview(e,t){var a,s=e?.substr(0,e.indexOf(":")),i=e?.substr(e.indexOf(":")+1);return"svg"===s?(a=e=>`<img src='${e.url}' alt='${e.alt}'>`,(e=wp.media.attachment(i)).get("url")?t(a(e.toJSON())):(async()=>wp.media.attachment(i).fetch())().then(e=>t(a(e)))):this.config[s]?(e=this.config[s],this.loadPack(e),t(`<i class='${i}'></i>`)):t("")}}})).config.globalProperties.emitter=Voxel_Backend.mitt(),e.mount("#voxel-icon-picker"),t=(e,t)=>{var a,s,t=i(t);t.data("icon-picker-inited")||(t.data("icon-picker-inited",!0),a=t.find("input"),s=t.find(".icon-preview"),Voxel_Icon_Picker.getIconPreview(a.val(),e=>s.html(e).attr("title",a.val())),t.find(".choose-icon, .icon-preview").on("click",e=>{e.preventDefault(),Voxel_Icon_Picker.edit(a.val(),e=>{e&&a.val(e.library+":"+e.value),Voxel_Icon_Picker.getIconPreview(a.val(),e=>s.html(e).attr("title",a.val()))})}),t.find(".clear-icon").on("click",e=>{e.preventDefault(),a.val(""),s.html("").attr("title","")}),t.find(".upload-svg").on("click",e=>{e.preventDefault(),Voxel_Icon_Picker.getSVG(e=>{e&&a.val("svg:"+e.id),Voxel_Icon_Picker.getIconPreview(a.val(),e=>s.html(e).attr("title",a.val()))})}))},window.voxel_init_icon_pickers=()=>{i(".ts-icon-picker:not(.ts-icon-picker-vue)").each(t)},window.voxel_init_icon_pickers())}),jQuery(e=>{var t,a;document.getElementById("voxel-reorder-terms")&&(t=document.getElementById("voxel-reorder-terms"),(a=Vue.createApp({data(){return{terms:JSON.parse(t.dataset.terms)}},methods:{getTermTree(){return this.terms.map(e=>({id:e.id,terms:this.getChildTerms(e)}))},getChildTerms(e){return e.children.map(e=>({id:e.id,terms:this.getChildTerms(e)}))},onSubmit(){this.$refs.termsInput.value=JSON.stringify(this.getTermTree())}}})).component("draggable",vuedraggable),a.component("term-list",{template:"#voxel-reorder-term-list-component",props:["terms","group","level","parent"],data(){return{items:this.terms}},methods:{onDragStart(){(this.$parent.$refs.list?this:this.$parent).$parent.$refs.list.classList.add("drag-active")},onDragEnd(){(this.$parent.$refs.list?this:this.$parent).$parent.$refs.list.classList.remove("drag-active"),1===this.level?this.$root.terms=this.items:this.parent.children=this.items},toggleCollapse(e){e.target.parentElement.classList.toggle("collapsed")}}}),a.mount("#voxel-reorder-terms"))});var a={template:`
		<div class="ts-icon-picker ts-icon-picker-vue">
			<div class="icon-preview" v-html="previewMarkup" @click.prevent="openLibrary" :title="modelValue"></div>

				<a href="#" @click.prevent="uploadSVG" class="ts-button ts-outline">Upload SVG</a>
				<a v-if="allowFonticons !== false" href="#" @click.prevent="openLibrary" class="ts-button ts-outline">Choose Icon</a>
				<a v-if="modelValue" href="#" @click.prevent="clear" class="ts-button ts-outline icon-only"><i class="lar la-trash-alt icon-sm"></i></a>

		</div>
	`,props:["modelValue","allowFonticons"],data(){return{previewMarkup:""}},created(){this.preview(this.modelValue)},methods:{preview(e){Voxel_Icon_Picker.getIconPreview(e,e=>this.previewMarkup=e)},openLibrary(){Voxel_Icon_Picker.edit(this.modelValue,e=>{this.setValue(e.library+":"+e.value)})},uploadSVG(){Voxel_Icon_Picker.getSVG(e=>{this.setValue("svg:"+e.id)})},clear(){this.setValue("")},setValue(e){this.preview(e),this.$emit("update:modelValue",e)}}},e=(jQuery(e=>{var t=document.getElementById("voxel-term-settings");if(t){window.$=jQuery;let e=JSON.parse(t.dataset.config).fields||{};t=Vue.createApp({data(){return{fields:{icon:e.icon||"",image:e.image||"",area:{address:e.area?.address||"",swlat:e.area?.swlat||"",swlng:e.area?.swlng||"",nelat:e.area?.nelat||"",nelng:e.area?.nelng||""},color:e.color||""}}},mounted(){Voxel.Maps.await(()=>{new Voxel.Maps.Autocomplete(this.$refs.addressInput,e=>{e?this.usePlaceData(e):(this.fields.area.address=this.$refs.addressInput.value,this.fields.area.address||(this.fields.area.swlat="",this.fields.area.swlng="",this.fields.area.nelat="",this.fields.area.nelng=""))})})},methods:{usePlaceData(e){var t=e.viewport.getSouthWest(),a=e.viewport.getNorthEast();this.fields.area.address=e.address,this.fields.area.swlat=this._shortenPoint(t.getLatitude()),this.fields.area.swlng=this._shortenPoint(t.getLongitude()),this.fields.area.nelat=this._shortenPoint(a.getLatitude()),this.fields.area.nelng=this._shortenPoint(a.getLongitude())},_shortenPoint(e){return e.toString().substr(0,e<0?9:8)}}});t.component("media-select",Voxel_Backend.components.Media_Select),t.component("color-picker",Voxel_Backend.components.Color_Picker),t.component("icon-picker",a),t.mount("#voxel-term-settings")}}),{props:["modelValue","editable","unlocked"],template:`
		<input type="text" :value="modelValue" ref="input" :disabled="!editing" @blur="blur">
		<div v-if="editable && editing && needsFormatting && false" class="edit-key" style="right: 46px;">
			<a @click.prevent="format" href="#" class="ts-button ts-faded prevent-blur" tabindex="-1">
				<i class="las la-magic"></i>
			</a>
		</div>
		<div v-if="editable" class="edit-key">
			<a v-if="!editing" @click.prevent="edit" href="#" class="ts-button ts-faded" tabindex="-1">
				<i class="las la-lock"></i>
			</a>
			<a v-if="editing" @click.prevent href="#" class="ts-button ts-faded" tabindex="-1">
				<i class="las la-unlock"></i>
			</a>
		</div>
	`,data(){return{editing:!1}},created(){this.unlocked&&this.enable()},methods:{edit(){this.editable&&(this.editing=!0,this.$refs.input.focus(),requestAnimationFrame(()=>{this.$refs.input.focus()}))},enable(){this.editable&&(this.editing=!0)},format(){this.$refs.input.value=this.formattedValue,this.$emit("update:modelValue",this.formattedValue)},blur(e){e.relatedTarget?.classList&&e.relatedTarget.classList.contains("prevent-blur")||(this.editing=!1,this.$emit("update:modelValue",this.$refs.input.value.trim()))}},computed:{formattedValue(){return Voxel_Backend.helpers.slugify(this.modelValue)},needsFormatting(){return this.$refs.input.value!==this.formattedValue}}}),t={props:["modelValue"],template:`
		<div class="ts-color-picker">
			<input type="text" :value="modelValue" ref="input" @input="saveInput">
			<div class="color-preview" :style="{ backgroundColor: modelValue || '#000000' }" @click="$refs.picker.click()"></div>
			<div class="color-wrapper"><input type="color" :value="modelValue || '#000000'" ref="picker" @change="savePicker"></div>
		</div>
	`,methods:{savePicker(){this.$emit("update:modelValue",this.$refs.picker.value)},saveInput(){this.$emit("update:modelValue",this.$refs.input.value)}}},s={props:["modelValue","taxonomies"],template:`
		<select ref="select" :value="modelValue" @change="save">
			<option v-for="choice in choices" :value="choice.key">{{ choice.label }}</option>
			<option v-for="choice in new_taxonomies_cache" :value="choice.key">{{ choice.label }}</option>
			<option value="__create"> &mdash; Create new taxonomy</option>
		</select>
		<div v-if="modelValue === '__create'" class="x-row create-tax-group">
			<div class="ts-form-group x-col-4">
				<label>Taxonomy label</label>
				<input type="text" v-model="customTax.label" @input="setTaxonomyKey" ref="taxLabel">
			</div>
			<div class="ts-form-group x-col-4">
				<label>Taxonomy key</label>
				<input type="text" v-model="customTax.key">
			</div>
			<div class="ts-form-group x-col-4">
				<label>&nbsp;</label>
				<a href="#" class="ts-button ts-faded full-width" @click.prevent="createTaxonomy">Create</a>
			</div>
		</div>
	`,data(){return"object"!=typeof window.VX_New_Taxonomies_Cache&&(window.VX_New_Taxonomies_Cache={}),{choices:{},customTax:{label:"",key:""},new_taxonomies_cache:window.VX_New_Taxonomies_Cache}},created(){this.choices=this.taxonomies},methods:{save(){this.$emit("update:modelValue",this.$refs.select.value),"__create"===this.modelValue&&this.$refs.taxLabel.focus()},setTaxonomyKey(){var e=this.$root.config.settings.key,t=Voxel_Backend.helpers.slugify(this.customTax.label).replace(/-/g,"_");this.customTax.key=e+"_"+t},createTaxonomy(){jQuery.post({url:Voxel_Config.ajax_url+"&action=create_taxonomy",data:{post_type:this.$root.config.settings.key,label:this.customTax.label,key:this.customTax.key},success:e=>{e.success?(window.VX_New_Taxonomies_Cache[e.taxonomy.key]={key:e.taxonomy.key,label:e.taxonomy.label},this.$emit("update:modelValue",e.taxonomy.key)):alert(e.message)}})}}},i={props:["modelValue","fileType","multiple"],template:`
		<div class="ts-media-select">
			<template v-if="modelValue">
				<img v-if="selected" :src="selected.sizes.thumbnail?.url || selected.url" :alt="selected.alt">
				<p>Attachment #{{ modelValue }}</p>
			</template>
			<div class="basic-ul">
				<a class="ts-button ts-outline" href="#" @click.prevent="open">Pick image</a>
				<a class="ts-button ts-outline icon-only" href="#" v-if="selected" @click.prevent="clear"><i class="lar la-trash-alt icon-sm"></i></a>
			</div>
		</div>
	`,data(){return{fileFrame:null,opened:!1,inited:!1,selected:null}},created(){var e;this.modelValue&&((e=wp.media.attachment(this.modelValue)).get("url")?this.selected=e.toJSON():(async()=>wp.media.attachment(this.modelValue).fetch())().then(e=>this.selected=e))},methods:{open(){this.inited||(this.inited=!0,e={},this.multiple&&(e.multiple=!0),this.fileType&&(e.library=wp.media.query({type:"string"==typeof this.fileType?[this.fileType]:this.fileType})),this.fileFrame=wp.media({states:new wp.media.controller.Library(e)}));var e,t=Vue.toRaw(this.fileFrame);t.open(),t.once("select",()=>{t.state().get("selection").each(e=>{this.selected=e.toJSON(),this.$emit("update:modelValue",this.selected.id)})}),this.opened=!0},clear(){this.selected=null,this.$emit("update:modelValue",null)}}};jQuery(e=>{var t=document.getElementById("vx-post-author");if(t){let e=JSON.parse(t.dataset.config);Vue.createApp({data(){return{author:e.author,search:{show:!1,term:"",loading:!1,results:null}}},methods:{searchUsers:Voxel_Backend.helpers.debounce(t=>{t.search.term=t.$refs.searchInput.value,t.search.term.trim().length?(t.search.loading=!0,jQuery.get(Voxel_Config.ajax_url,{action:"general.search_users",search:t.search.term}).always(e=>{t.search.loading=!1,e.success?t.search.results=e.results:Voxel_Backend.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})):t.search.results=[]},150),setAuthor(e){this.author=e,this.$refs.input.value=e.id,this.search.show=!1},showSearch(){this.search.show=!this.search.show,this.search.show&&requestAnimationFrame(()=>this.$refs.searchInput.focus())}}}).mount("#vx-post-author")}}),jQuery(e=>{var t=document.getElementById("vx-post-expiry");if(t){let e=JSON.parse(t.dataset.config);Vue.createApp({data(){return{expiry_mode:e.expiry_mode,custom_expiry:e.custom_expiry,show_rules:!1}}}).mount("#vx-post-expiry")}}),window.Voxel_Backend={mitt:function(s){return{all:s=s||new Map,on(e,t){var a=s.get(e);a&&a.push(t)||s.set(e,[t])},off(e,t){e=s.get(e);e&&e.splice(e.indexOf(t)>>>0,1)},emit(t,a){(s.get(t)||[]).slice().map(e=>{e(a)}),(s.get("*")||[]).slice().map(e=>{e(t,a)})}}},helpers:{isAnyPartOfElementInViewport(e){var e=e.getBoundingClientRect(),t=window.innerHeight||document.documentElement.clientHeight,a=window.innerWidth||document.documentElement.clientWidth,t=e.top<=t&&0<=e.top+e.height,a=e.left<=a&&0<=e.left+e.width;return t&&a},slugify(e){return e.toString().trim().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-\.\:]+/g,"")},debounce(t,a=200){let s;return(...e)=>{clearTimeout(s),s=setTimeout(()=>{t.apply(this,e)},a)}}},components:{Field_Key:e,Taxonomy_Select:s,Media_Select:i,Color_Picker:t},alert(e,t="info",a=7500){var t=document.getElementById("vx-alert-tpl").textContent.replace("{type}",t).replace("{message}",e),s=jQuery(t).hide();s.find("> a").on("click",e=>{e.preventDefault(),s.fadeOut(100,()=>s.remove())}),"number"==typeof a&&0<a&&setTimeout(()=>s.fadeOut(100,()=>s.remove()),a),s.appendTo(jQuery("#vx-alert")),s.fadeIn(100)},_nav_dtags(t){DTags.edit(t.querySelector("input").value,e=>{t.querySelector("input").value=e})},_nav_visibility(t){var e=t.querySelector("input").value;let a=[];try{a=JSON.parse(e)}catch(e){}DTags.editVisibility(a,e=>{t.querySelector("input").value=JSON.stringify(e),t.querySelector(".vx-visibility-rules").innerHTML=DTags.formatRulesAsHTML(a)})},_nav_display_rules(e){var t=e.querySelector("input").value;let a=[];try{a=JSON.parse(t)}catch(e){}e.querySelector(".vx-visibility-rules").innerHTML=DTags.formatRulesAsHTML(a)},getSearchParam(e){return new URL(window.location).searchParams.get(e)},setSearchParam(e,t){var a=new URL(window.location);a.searchParams.set(e,t),window.history.replaceState(null,null,a)},deleteSearchParam(e){var t=new URL(window.location);t.searchParams.delete(e),window.history.replaceState(null,null,t)}},jQuery(e=>{var s=document.body.classList.contains("block-editor-page"),o=document.getElementById("vx-fields-wrapper");if(o){let i=o.querySelector(":scope > iframe"),t,r=new ResizeObserver(e=>requestAnimationFrame(()=>{0!==e[0].target.offsetHeight&&(i.style.height=e[0].target.offsetHeight+"px")})),a=(t=s?()=>{var e=Array.from(document.querySelectorAll(".editor-post-publish-button__button, .editor-post-save-draft"));if(e.length){r.observe(i.contentWindow.document.body);let a=!1;window.addEventListener("message",e=>{if("create-post:submitted"===e.data){a=!1,i.contentWindow.location.reload();let t=e=>{"create-post:mounted"===e.data&&(document.getElementById("vx-fields-wrapper").classList.remove("ts-saving"),window.removeEventListener("message",t))};window.addEventListener("message",t)}}),e.forEach(e=>{jQuery(".edit-post-header__settings").on("click",".editor-post-publish-button__button, .editor-post-save-draft",e=>{a||(a=!0,i.contentWindow.document.querySelector(".ts-create-post .ts-save-changes").click(),document.getElementById("vx-fields-wrapper").classList.add("ts-saving"))})})}else setTimeout(()=>t(),500)}:()=>{r.observe(i.contentWindow.document.body);let a=!1,s=null;window.addEventListener("message",e=>{"create-post:submitted"===e.data&&(a=!0,s?.classList.remove("vx-disabled"),s?.click())}),Array.from(document.querySelectorAll("#publish, #save-post")).forEach(e=>{let t=e=>{s=e.currentTarget,a||(e.preventDefault(),i.contentWindow.document.querySelector(".ts-create-post .ts-save-changes").click(),document.getElementById("vx-fields-wrapper").classList.add("ts-saving"),s.classList.add("vx-disabled"),s.removeEventListener("click",t))};e.addEventListener("click",t)})},e=>{"create-post:mounted"===e.data&&(t(),window.removeEventListener("message",a))});window.addEventListener("message",a),window.addEventListener("message",e=>{"create-post:mounted"===e.data&&requestAnimationFrame(()=>{0!==i.contentWindow.document.body.offsetHeight&&(i.style.height=i.contentWindow.document.body.offsetHeight+"px")})}),i.src=i.dataset.src}}),jQuery(a=>{a("a[vx-action]:not(.vx-event-action)").addClass("vx-event-action").each((e,t)=>{a(t).on("click",a=>{var e;a.preventDefault(),a.currentTarget.dataset.confirm&&!confirm(a.currentTarget.dataset.confirm)||(a.currentTarget.classList.add("vx-disabled"),e=a.currentTarget.href,jQuery.get(e,e=>{if(e.success){if(e.message&&Voxel_Backend.alert(e.message,e.message_type||"success"),e.redirect_to)return"(reload)"===e.redirect_to?location.reload():window.location.href=e.redirect_to,void a.currentTarget.classList.remove("vx-disabled")}else{var t=Voxel_Config.l10n.ajaxError,e=e.message||t;Voxel_Backend.alert(e,"error")}a.currentTarget.classList.remove("vx-disabled")}).fail(()=>{var e=Voxel_Config.l10n.ajaxError,e=response.message||e;Voxel_Backend.alert(e,"error"),a.currentTarget.classList.remove("vx-disabled")}))})})}),jQuery(".tablenav.top .bulkactions").on("click",".ts-terms-cache-post-counts",e=>{e.preventDefault();let a=e.currentTarget,t=(a.classList.add("vx-inert"),a.innerText="Caching post counts",a.dataset.taxonomy),s=0,i=()=>{jQuery.get(`${Voxel_Config.ajax_url}&action=backend.terms.cache_post_counts&taxonomy=${t}&offset=`+s).always(e=>{var t;e.success?(console.log(e),e.has_more&&e.offset!==e.total?(t=e.offset/e.total*100,a.innerText=`Caching post counts (${t.toFixed(1)}%)`,s=e.offset,i()):a.innerText="Done"):Voxel_Backend.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})};i()})});
